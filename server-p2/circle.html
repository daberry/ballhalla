<!DOCTYPE html>
<html lang="en">
  <head>
    <title>p2.js Canvas Box example</title>
    <meta charset="utf-8">
    <script src="p2.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
  </head>
  <body>

    <!-- The canvas, where we draw stuff -->
    <canvas width="1200" height="1800" id="myCanvas"></canvas>

    <script>

      var canvas, ctx, w, h,
        world, circleBody, planeBody;
      var leftWallBody;
      var circleShapeServer, circleBodyServer;
      var socket;
      var yDiffStore = [];

      init();
      animate();

      function init(){

        // Init canvas
        canvas = document.getElementById("myCanvas");
        w = canvas.width;
        h = canvas.height;

        ctx = canvas.getContext("2d");
        ctx.lineWidth = 0.05;

        // Init p2.js
        world = new p2.World({
          gravity:[0, -9.82]
        });

        // Add a circle
        circleShape = new p2.Circle({ radius: 1 });
        circleBody = new p2.Body({ mass:1, position:[0,3] });
        circleBody.addShape(circleShape);
        world.addBody(circleBody);

        circleShapeServer = new p2.Circle({ radius: 1 });
        circleBodyServer = new p2.Body({ mass:1, position:[0,3] });
        circleBodyServer.addShape(circleShapeServer);
        world.addBody(circleBodyServer);

        // Add a plane
        planeShape = new p2.Plane();
        planeBody = new p2.Body();
        planeBody.addShape(planeShape);
        world.addBody(planeBody);

//        leftWallBody = new p2.Body({
//          angle: Math.PI/2,
//          position: [-7, 0]
//        });
//        leftWallBody.addShape(new p2.Plane());
//        world.addBody(leftWallBody);

        socket = window.io();
      }

      function drawCircle(){
        ctx.beginPath();
        var x = circleBody.position[0],
          y = circleBody.position[1],
          radius = circleShape.radius;
        ctx.arc(x,y,radius,0,2*Math.PI);
        ctx.stroke();

        ctx.beginPath();
        var x = circleBodyServer.position[0],
          y = circleBodyServer.position[1],
          radius = circleShapeServer.radius;
        ctx.arc(x,y,radius,0,2*Math.PI);
        ctx.stroke();
      }

      function drawPlane(){
        var y = planeBody.position[1];
        ctx.moveTo(-w, y);
        ctx.lineTo(w, y);
        ctx.stroke();

      }
//      function drawLeftPlane() {
//
//        //var y2 = leftWallBody.position[1];
//        ctx.moveTo(-7, 0);
//        ctx.moveTo(-7, h);
//        ctx.stroke();
//      }

      function render(){
        // Clear the canvas
        ctx.clearRect(0,0,w,h);

        // Transform the canvas
        // Note that we need to flip the y axis since Canvas pixel coordinates
        // goes from top to bottom, while physics does the opposite.
        ctx.save();
        ctx.translate(w/2, h/2);  // Translate to the center
        ctx.scale(50, -50);       // Zoom in and flip y axis

        // Draw all bodies
        drawCircle();
        drawPlane();

        // Restore transform
        ctx.restore();
      }

      // Animation loop
      function animate(){
        requestAnimationFrame(animate);

        // Move physics bodies forward in time
        world.step(1/60);

        // Render scene
        render();
      }
      socket.on('circleUpdate', function(data) {

        circleBodyServer.position = [data.x - 2.3, data.y];
        circleBodyServer.velocity = [data.vx, data.vy];
        circleBody.position = [data.x, data.y];
        circleBody.velocity = [data.vx, data.vy]
      });
      document.onkeydown = checkKey;

      function checkKey(e) {

        e = e || window.event;

        if (e.keyCode == '38') {
          circleBody.velocity[1] += 3;
          console.log('up arrow lol');
          socket.emit('addVelocity', {
              x: 0,
              y: 3
            });
        }
        else if (e.keyCode == '40') {
          // down arrow
          circleBody.velocity[1] += 3;
          console.log('up arrow lol');
          socket.emit('addVelocity', {
            x: 0,
            y: -3
          });
        }
        else if (e.keyCode == '37') {
          // left arrow
          circleBody.velocity[1] += 3;
          console.log('up arrow lol');
          socket.emit('addVelocity', {
            x: -3,
            y: 0
          });
        }
        else if (e.keyCode == '39') {
          // right arrow
          circleBody.velocity[1] += 3;
          console.log('up arrow lol');
          socket.emit('addVelocity', {
            x: 3,
            y: 0
          });
        }
      }

    </script>

  </body>
</html>
